{% comment %}
Infinite Slideshow Section â€” fully working
- Infinite loop both directions
- Arrows on image center
- Auto-slide optional
- Desktop + mobile images
{% endcomment %}

<style>
  .infinite-slideshow {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .infinite-slideshow__track {
    display: flex;
    transition: transform 0.6s ease;
    will-change: transform;
  }

  .infinite-slideshow__slide {
    flex: 0 0 100%;
    position: relative;
  }

  .infinite-slideshow__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Arrows */
  .infinite-slideshow__button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: white;
    font-size: 48px;
    cursor: pointer;
    z-index: 5;
    padding: 5px 12px;
    user-select: none;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);
  }

  .infinite-slideshow__button--prev {
    left: 10px;
  }
  .infinite-slideshow__button--next {
    right: 10px;
  }

  @media (max-width: 749px) {
    .infinite-slideshow__button {
      font-size: 32px;
      padding: 4px 8px;
    }
  }
</style>

<section
  class="infinite-slideshow"
  id="Slideshow-{{ section.id }}"
  data-autoplay="{{ section.settings.auto_rotate }}"
  data-speed="{{ section.settings.change_slides_speed }}"
>
  <!-- Buttons -->
  <button
    type="button"
    class="infinite-slideshow__button infinite-slideshow__button--prev"
    aria-label="Previous slide"
  >
    &#10094;
  </button>
  <button
    type="button"
    class="infinite-slideshow__button infinite-slideshow__button--next"
    aria-label="Next slide"
  >
    &#10095;
  </button>

  <!-- Track -->
  <div class="infinite-slideshow__track" id="Slider-{{ section.id }}">
    {% for block in section.blocks %}
      <div class="infinite-slideshow__slide" id="Slide-{{ section.id }}-{{ forloop.index }}">
        <picture>
          {% if block.settings.image_mobile %}
            <source
              srcset="{{ block.settings.image_mobile | image_url: width: 800 }}"
              media="(max-width: 749px)"
            >
          {% endif %}
          {% if block.settings.image_desktop %}
            {{
              block.settings.image_desktop
              | image_url: width: 1600
              | image_tag:
                  alt: block.settings.alt_text,
                  class: 'infinite-slideshow__image',
                  loading: 'lazy'
            }}
          {% else %}
            {{ 'hero-apparel-1' | placeholder_svg_tag }}
          {% endif %}
        </picture>
      </div>
    {% endfor %}
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const root = document.getElementById("Slideshow-{{ section.id }}");
  if (!root) return;

  const track = root.querySelector(".infinite-slideshow__track");
  const slides = Array.from(track.children);
  const prev = root.querySelector(".infinite-slideshow__button--prev");
  const next = root.querySelector(".infinite-slideshow__button--next");

  let index = 0;
  let slideWidth = slides[0].getBoundingClientRect().width;

  // ðŸ§  Function to move slide
  function goTo(newIndex) {
    index = (newIndex + slides.length) % slides.length; // Circular logic
    track.style.transition = "transform 0.6s ease";
    track.style.transform = `translateX(${-index * slideWidth}px)`;
  }

  // ðŸ§­ Buttons
  prev.addEventListener("click", () => goTo(index - 1));
  next.addEventListener("click", () => goTo(index + 1));

  // ðŸª„ Re-measure on resize
  window.addEventListener("resize", () => {
    slideWidth = slides[0].getBoundingClientRect().width;
    track.style.transition = "none";
    track.style.transform = `translateX(${-index * slideWidth}px)`;
  });

  // âš™ï¸ Auto-slide logic
  const autoplay = root.dataset.autoplay === "true";
  const speed = parseInt(root.dataset.speed || "5", 10) * 1000;
  let timer;

  function startAuto() {
    if (!autoplay) return;
    stopAuto();
    timer = setInterval(() => goTo(index + 1), speed);
  }

  function stopAuto() {
    if (timer) clearInterval(timer);
  }

  root.addEventListener("mouseenter", stopAuto);
  root.addEventListener("mouseleave", startAuto);

  startAuto();
});
</script>

{% schema %}
{
  "name": "Infinite Slideshow",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Enable auto-slide",
      "default": true
    },
    {
      "type": "range",
      "id": "change_slides_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Slide change interval",
      "default": 5
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "image_desktop", "label": "Desktop image" },
        { "type": "image_picker", "id": "image_mobile", "label": "Mobile image (optional)" },
        { "type": "text", "id": "alt_text", "label": "Alt text" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Infinite Slideshow",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
