{% comment %}
Infinite Slideshow Section â€” fully working
- Infinite loop both directions with seamless transitions
- Arrows on image center
- Auto-slide optional
- Desktop + mobile images
- Slide cloning for smooth looping
{% endcomment %}

<style>
  .infinite-slideshow {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .infinite-slideshow__track {
    display: flex;
    transition: transform 0.6s ease;
    will-change: transform;
  }

  .infinite-slideshow__slide {
    flex: 0 0 100%;
    position: relative;
  }

  .infinite-slideshow__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Arrows */
  .infinite-slideshow__button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: white;
    font-size: 48px;
    cursor: pointer;
    z-index: 5;
    padding: 5px 12px;
    user-select: none;
    text-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);
    transition: opacity 0.2s ease;
  }

  .infinite-slideshow__button:hover {
    opacity: 0.8;
  }

  .infinite-slideshow__button--prev {
    left: 10px;
  }

  .infinite-slideshow__button--next {
    right: 10px;
  }

  @media (max-width: 749px) {
    .infinite-slideshow__button {
      font-size: 32px;
      padding: 4px 8px;
    }
  }
</style>

<section
  class="infinite-slideshow"
  id="Slideshow-{{ section.id }}"
  data-autoplay="{{ section.settings.auto_rotate }}"
  data-speed="{{ section.settings.change_slides_speed }}"
>
  <!-- Buttons -->
  <button
    type="button"
    class="infinite-slideshow__button infinite-slideshow__button--prev"
    aria-label="Previous slide"
  >
    &#10094;
  </button>
  <button
    type="button"
    class="infinite-slideshow__button infinite-slideshow__button--next"
    aria-label="Next slide"
  >
    &#10095;
  </button>

  <!-- Track -->
  <div class="infinite-slideshow__track" id="Slider-{{ section.id }}">
    {% for block in section.blocks %}
      <div class="infinite-slideshow__slide" id="Slide-{{ section.id }}-{{ forloop.index }}">
        <picture>
          {% if block.settings.image_mobile %}
            <source
              srcset="{{ block.settings.image_mobile | image_url: width: 800 }}"
              media="(max-width: 749px)"
            >
          {% endif %}
          {% if block.settings.image_desktop %}
            {{
              block.settings.image_desktop
              | image_url: width: 1600
              | image_tag:
                  alt: block.settings.alt_text,
                  class: 'infinite-slideshow__image',
                  loading: 'lazy'
            }}
          {% else %}
            {{ 'hero-apparel-1' | placeholder_svg_tag }}
          {% endif %}
        </picture>
      </div>
    {% endfor %}
  </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
  function initSlideshow() {
    const root = document.getElementById("Slideshow-{{ section.id }}");
    if (!root) return;

    const track = root.querySelector(".infinite-slideshow__track");
    let slides = Array.from(track.children);
    const originalSlideCount = slides.length;

    if (originalSlideCount === 0) return;

    const prev = root.querySelector(".infinite-slideshow__button--prev");
    const next = root.querySelector(".infinite-slideshow__button--next");

    // Clone first and last slides for infinite effect
    const firstClone = slides[0].cloneNode(true);
    const lastClone = slides[originalSlideCount - 1].cloneNode(true);

    track.appendChild(firstClone);
    track.insertBefore(lastClone, slides[0]);

    // Update slides array to include clones
    slides = Array.from(track.children);
    let index = 1; // Start at the first real slide (after lastClone)
    let slideWidth = slides[0].getBoundingClientRect().width;

    // Set initial position without transition
    track.style.transition = "none";
    track.style.transform = `translateX(${-index * slideWidth}px)`;

    function goTo(newIndex, animate = true) {
      if (animate) {
        track.style.transition = "transform 0.6s ease";
      } else {
        track.style.transition = "none";
      }

      track.style.transform = `translateX(${-newIndex * slideWidth}px)`;
      index = newIndex;
    }

    function handleNext() {
      goTo(index + 1);

      // If we reached the cloned first slide, snap back to real first slide
      if (index === slides.length - 1) {
        setTimeout(() => {
          goTo(1, false); // Jump without animation
        }, 600); // Match transition duration
      }
    }

    function handlePrev() {
      goTo(index - 1);

      // If we reached the cloned last slide, snap back to real last slide
      if (index === 0) {
        setTimeout(() => {
          goTo(slides.length - 2, false); // Jump without animation
        }, 600); // Match transition duration
      }
    }

    prev?.addEventListener("click", handlePrev);
    next?.addEventListener("click", handleNext);

    // Re-measure on resize
    let resizeTimer;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        slideWidth = slides[0].getBoundingClientRect().width;
        track.style.transition = "none";
        track.style.transform = `translateX(${-index * slideWidth}px)`;
      }, 150);
    });

    // Auto-slide logic
    const autoplay = root.dataset.autoplay === "true";
    const speed = parseInt(root.dataset.speed || "5", 10) * 1000;
    let timer;

    function startAuto() {
      if (!autoplay) return;
      stopAuto();
      timer = setInterval(handleNext, speed);
    }

    function stopAuto() {
      if (timer) clearInterval(timer);
    }

    root.addEventListener("mouseenter", stopAuto);
    root.addEventListener("mouseleave", startAuto);

    startAuto();
  }

  // Initialize on page load
  initSlideshow();

  // Reinitialize when section is edited in theme editor
  document.addEventListener("shopify:section:load", function (event) {
    if (event.detail.sectionId === "{{ section.id }}") {
      initSlideshow();
    }
  });
});
</script>

{% schema %}
{
  "name": "Infinite Slideshow",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "auto_rotate",
      "label": "Enable auto-slide",
      "default": true
    },
    {
      "type": "range",
      "id": "change_slides_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Slide change interval",
      "default": 5
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Slide",
      "settings": [
        { "type": "image_picker", "id": "image_desktop", "label": "Desktop image" },
        { "type": "image_picker", "id": "image_mobile", "label": "Mobile image (optional)" },
        { "type": "text", "id": "alt_text", "label": "Alt text" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Infinite Slideshow",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "slide" }
      ]
    }
  ]
}
{% endschema %}
